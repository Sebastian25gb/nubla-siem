#!/bin/bash
# Limpiar reglas existentes
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo iptables -t mangle -F
sudo iptables -t mangle -X

# Crear cadenas de Docker si no existen
sudo iptables -N DOCKER || true
sudo iptables -N DOCKER-FORWARD || true
sudo iptables -t nat -N DOCKER || true

# PolÃ­ticas
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD ACCEPT  # Necesario para Docker
sudo iptables -P OUTPUT ACCEPT

# Reglas esenciales
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Puertos expuestos
sudo iptables -A INPUT -p tcp --dport 8000 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 9200 -j ACCEPT

# Reglas para Docker
sudo iptables -A INPUT -i docker0 -j ACCEPT
sudo iptables -A INPUT -i br-8092d8f9d0b4 -j ACCEPT
sudo iptables -A FORWARD -i docker0 -o docker0 -j ACCEPT
sudo iptables -A FORWARD -i br-8092d8f9d0b4 -o br-8092d8f9d0b4 -j ACCEPT
sudo iptables -A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -o br-8092d8f9d0b4 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -t nat -A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
sudo iptables -t nat -A POSTROUTING -s 172.18.0.0/16 ! -o br-8092d8f9d0b4 -j MASQUERADE
sudo iptables -t nat -A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
sudo iptables -t nat -A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER

# Reglas internas para contenedores
sudo iptables -A INPUT -i docker0 -p tcp --dport 2181 -j ACCEPT
sudo iptables -A INPUT -i docker0 -p tcp --dport 9092 -j ACCEPT
sudo iptables -A INPUT -i docker0 -p tcp --dport 5432 -j ACCEPT
sudo iptables -A INPUT -i docker0 -p tcp --dport 6379 -j ACCEPT
sudo iptables -A INPUT -i docker0 -p tcp --dport 9200 -j ACCEPT
sudo iptables -A INPUT -i br-8092d8f9d0b4 -p tcp --dport 2181 -j ACCEPT
sudo iptables -A INPUT -i br-8092d8f9d0b4 -p tcp --dport 9092 -j ACCEPT
sudo iptables -A INPUT -i br-8092d8f9d0b4 -p tcp --dport 5432 -j ACCEPT
sudo iptables -A INPUT -i br-8092d8f9d0b4 -p tcp --dport 6379 -j ACCEPT
sudo iptables -A INPUT -i br-8092d8f9d0b4 -p tcp --dport 9200 -j ACCEPT

# Guardar reglas
sudo service iptables save
sudo iptables-save > /etc/sysconfig/iptables