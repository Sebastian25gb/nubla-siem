# Entrada UDP cruda (no intentar parsear syslog); esto evita errores con Fortinet key=value
<source>
  @type udp
  bind 0.0.0.0
  port 24224
  tag syslog
  <parse>
    @type none
  </parse>
</source>

# Salida a RabbitMQ como JSON, con buffer y reintentos
<match syslog.**>
  @type rabbitmq

  # Conexión
  host "#{ENV['RABBITMQ_HOST'] || 'rabbitmq'}"
  port 5672
  vhost "/"
  user "#{ENV['RABBITMQ_USER'] || 'admin'}"
  pass "#{ENV['RABBITMQ_PASSWORD'] || 'securepass'}"

  # Topología (usa el exchange definido en tu .env, p.ej. logs_siem)
  exchange "#{ENV['RABBITMQ_EXCHANGE'] || 'logs_default'}"
  exchange_type "topic"
  routing_key "#{ENV['RABBITMQ_ROUTING_KEY'] || 'nubla.log.default'}"

  # Serializa el record (incluye 'message') a JSON
  <format>
    @type json
  </format>

  # Buffer y reintentos
  <buffer>
    @type memory
    flush_interval 5s
    flush_thread_count 2
    flush_at_shutdown true
    retry_max_interval 60s
    retry_forever true
    chunk_limit_size 1m
    total_limit_size 64m
  </buffer>
</match>